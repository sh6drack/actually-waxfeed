From 3aeabbb6d7dfc70d3a55785763486e9d57308eff Mon Sep 17 00:00:00 2001
From: Shadrack Annor <shadrack@Shadracks-MacBook-Air-10.local>
Date: Sun, 25 Jan 2026 17:41:44 -0500
Subject: [PATCH 28/50] Fix hot takes 404 error and add individual hot take
 view

- Add API route /api/hot-takes/[id] to fetch single hot take
- Add API route /api/hot-takes/[id]/vote to handle voting
- Add page /hot-takes/[id] to display individual hot take details
- Fix server component error by removing function prop from HotTakeCard
- Update HotTakeCard to call vote API directly when no callback provided

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
---
 src/app/api/hot-takes/[id]/route.ts      | 115 ++++++++
 src/app/api/hot-takes/[id]/vote/route.ts |  89 ++++++
 src/app/hot-takes/[id]/page.tsx          | 357 +++++++++++++++++++++++
 src/app/hot-takes/page.tsx               |   3 -
 src/components/hot-take-card.tsx         |  22 +-
 5 files changed, 579 insertions(+), 7 deletions(-)
 create mode 100644 src/app/api/hot-takes/[id]/route.ts
 create mode 100644 src/app/api/hot-takes/[id]/vote/route.ts
 create mode 100644 src/app/hot-takes/[id]/page.tsx

diff --git a/src/app/api/hot-takes/[id]/route.ts b/src/app/api/hot-takes/[id]/route.ts
new file mode 100644
index 0000000..4bf2424
--- /dev/null
+++ b/src/app/api/hot-takes/[id]/route.ts
@@ -0,0 +1,115 @@
+import { NextRequest } from 'next/server'
+import { prisma } from '@/lib/prisma'
+import { successResponse, errorResponse, getAuthenticatedUser } from '@/lib/api-utils'
+
+// GET /api/hot-takes/[id] - Get single hot take
+export async function GET(
+  request: NextRequest,
+  { params }: { params: Promise<{ id: string }> }
+) {
+  try {
+    const { id } = await params
+    const user = await getAuthenticatedUser()
+
+    const hotTake = await prisma.hotTake.findUnique({
+      where: { id },
+      include: {
+        album: {
+          select: {
+            id: true,
+            spotifyId: true,
+            title: true,
+            artistName: true,
+            coverArtUrl: true,
+            coverArtUrlLarge: true,
+          },
+        },
+        author: {
+          select: {
+            id: true,
+            username: true,
+            image: true,
+          },
+        },
+        votes: {
+          select: {
+            vote: true,
+          },
+        },
+        arguments: {
+          orderBy: [{ likes: 'desc' }, { createdAt: 'asc' }],
+          include: {
+            author: {
+              select: {
+                id: true,
+                username: true,
+                image: true,
+              },
+            },
+          },
+        },
+      },
+    })
+
+    if (!hotTake) {
+      return errorResponse('Hot take not found', 404)
+    }
+
+    // Calculate vote counts
+    const agreeCount = hotTake.votes.filter(v => v.vote === 'agree').length
+    const disagreeCount = hotTake.votes.filter(v => v.vote === 'disagree').length
+
+    // Check if user has voted
+    let userVote: 'agree' | 'disagree' | null = null
+    if (user) {
+      const vote = await prisma.hotTakeVote.findUnique({
+        where: { hotTakeId_userId: { hotTakeId: id, userId: user.id } },
+      })
+      userVote = vote?.vote as 'agree' | 'disagree' | null
+    }
+
+    // Separate arguments by side
+    const agreeArguments = hotTake.arguments.filter(a => a.side === 'agree')
+    const disagreeArguments = hotTake.arguments.filter(a => a.side === 'disagree')
+
+    return successResponse({
+      id: hotTake.id,
+      albumId: hotTake.album.id,
+      albumSpotifyId: hotTake.album.spotifyId,
+      albumTitle: hotTake.album.title,
+      albumArtist: hotTake.album.artistName,
+      albumCoverUrl: hotTake.album.coverArtUrl,
+      albumCoverUrlLarge: hotTake.album.coverArtUrlLarge,
+      stance: hotTake.stance,
+      content: hotTake.content,
+      authorId: hotTake.author.id,
+      authorUsername: hotTake.author.username,
+      authorImage: hotTake.author.image,
+      createdAt: hotTake.createdAt.toISOString(),
+      agreeCount,
+      disagreeCount,
+      userVote,
+      agreeArguments: agreeArguments.map(a => ({
+        id: a.id,
+        content: a.content,
+        authorId: a.author.id,
+        authorUsername: a.author.username,
+        authorImage: a.author.image,
+        likes: a.likes,
+        createdAt: a.createdAt.toISOString(),
+      })),
+      disagreeArguments: disagreeArguments.map(a => ({
+        id: a.id,
+        content: a.content,
+        authorId: a.author.id,
+        authorUsername: a.author.username,
+        authorImage: a.author.image,
+        likes: a.likes,
+        createdAt: a.createdAt.toISOString(),
+      })),
+    })
+  } catch (error) {
+    console.error('Error fetching hot take:', error)
+    return errorResponse('Failed to fetch hot take', 500)
+  }
+}
diff --git a/src/app/api/hot-takes/[id]/vote/route.ts b/src/app/api/hot-takes/[id]/vote/route.ts
new file mode 100644
index 0000000..5f1b4e0
--- /dev/null
+++ b/src/app/api/hot-takes/[id]/vote/route.ts
@@ -0,0 +1,89 @@
+import { NextRequest } from 'next/server'
+import { prisma } from '@/lib/prisma'
+import { successResponse, errorResponse, requireAuth } from '@/lib/api-utils'
+import { z } from 'zod'
+
+const voteSchema = z.object({
+  vote: z.enum(['agree', 'disagree']),
+})
+
+// POST /api/hot-takes/[id]/vote - Vote on a hot take
+export async function POST(
+  request: NextRequest,
+  { params }: { params: Promise<{ id: string }> }
+) {
+  try {
+    const { id } = await params
+    const user = await requireAuth()
+    const body = await request.json()
+
+    const parsed = voteSchema.safeParse(body)
+    if (!parsed.success) {
+      return errorResponse(parsed.error.errors[0].message, 400)
+    }
+
+    const { vote } = parsed.data
+
+    // Verify hot take exists
+    const hotTake = await prisma.hotTake.findUnique({
+      where: { id },
+    })
+
+    if (!hotTake) {
+      return errorResponse('Hot take not found', 404)
+    }
+
+    // Check existing vote
+    const existingVote = await prisma.hotTakeVote.findUnique({
+      where: { hotTakeId_userId: { hotTakeId: id, userId: user.id } },
+    })
+
+    if (existingVote) {
+      if (existingVote.vote === vote) {
+        // Remove vote (toggle off)
+        await prisma.hotTakeVote.delete({
+          where: { id: existingVote.id },
+        })
+
+        // Update cached vote count
+        await prisma.hotTake.update({
+          where: { id },
+          data: { voteCount: { decrement: 1 } },
+        })
+
+        return successResponse({ voted: false, vote: null })
+      } else {
+        // Change vote
+        await prisma.hotTakeVote.update({
+          where: { id: existingVote.id },
+          data: { vote },
+        })
+
+        return successResponse({ voted: true, vote })
+      }
+    } else {
+      // Create new vote
+      await prisma.hotTakeVote.create({
+        data: {
+          hotTakeId: id,
+          userId: user.id,
+          vote,
+        },
+      })
+
+      // Update cached vote count
+      await prisma.hotTake.update({
+        where: { id },
+        data: { voteCount: { increment: 1 } },
+      })
+
+      return successResponse({ voted: true, vote })
+    }
+  } catch (error) {
+    if (error instanceof Error && error.message === 'UNAUTHORIZED') {
+      return errorResponse('Sign in to vote', 401)
+    }
+    console.error('Error voting on hot take:', error)
+    return errorResponse('Failed to vote', 500)
+  }
+}
diff --git a/src/app/hot-takes/[id]/page.tsx b/src/app/hot-takes/[id]/page.tsx
new file mode 100644
index 0000000..b49edb0
--- /dev/null
+++ b/src/app/hot-takes/[id]/page.tsx
@@ -0,0 +1,357 @@
+"use client"
+
+import { useState, useEffect } from "react"
+import { useParams, useRouter } from "next/navigation"
+import Link from "next/link"
+
+const STANCE_LABELS: Record<string, { label: string; color: string }> = {
+  OVERRATED: { label: "OVERRATED", color: "#ff3b3b" },
+  UNDERRATED: { label: "UNDERRATED", color: "#3bff6f" },
+  MASTERPIECE: { label: "MASTERPIECE", color: "#ffd700" },
+  TRASH: { label: "TRASH", color: "#ff3b3b" },
+  AHEAD_OF_TIME: { label: "AHEAD OF ITS TIME", color: "#3b9fff" },
+  DATED: { label: "DATED", color: "#888888" },
+}
+
+interface Argument {
+  id: string
+  content: string
+  authorId: string
+  authorUsername: string
+  authorImage: string | null
+  likes: number
+  createdAt: string
+}
+
+interface HotTakeData {
+  id: string
+  albumId: string
+  albumSpotifyId: string
+  albumTitle: string
+  albumArtist: string
+  albumCoverUrl: string | null
+  albumCoverUrlLarge: string | null
+  stance: string
+  content: string
+  authorId: string
+  authorUsername: string
+  authorImage: string | null
+  createdAt: string
+  agreeCount: number
+  disagreeCount: number
+  userVote: "agree" | "disagree" | null
+  agreeArguments: Argument[]
+  disagreeArguments: Argument[]
+}
+
+export default function HotTakePage() {
+  const params = useParams()
+  const router = useRouter()
+  const [hotTake, setHotTake] = useState<HotTakeData | null>(null)
+  const [loading, setLoading] = useState(true)
+  const [error, setError] = useState<string | null>(null)
+  const [isVoting, setIsVoting] = useState(false)
+  const [localVote, setLocalVote] = useState<"agree" | "disagree" | null>(null)
+  const [localAgree, setLocalAgree] = useState(0)
+  const [localDisagree, setLocalDisagree] = useState(0)
+
+  useEffect(() => {
+    async function fetchHotTake() {
+      try {
+        const res = await fetch(`/api/hot-takes/${params.id}`)
+        if (!res.ok) {
+          if (res.status === 404) {
+            setError("Hot take not found")
+          } else {
+            setError("Failed to load hot take")
+          }
+          return
+        }
+        const data = await res.json()
+        setHotTake(data.data)
+        setLocalVote(data.data.userVote)
+        setLocalAgree(data.data.agreeCount)
+        setLocalDisagree(data.data.disagreeCount)
+      } catch {
+        setError("Failed to load hot take")
+      } finally {
+        setLoading(false)
+      }
+    }
+
+    fetchHotTake()
+  }, [params.id])
+
+  const handleVote = async (vote: "agree" | "disagree") => {
+    if (isVoting) return
+
+    setIsVoting(true)
+    const previousVote = localVote
+    const previousAgree = localAgree
+    const previousDisagree = localDisagree
+
+    // Optimistic update
+    if (localVote === vote) {
+      setLocalVote(null)
+      if (vote === "agree") setLocalAgree((v) => v - 1)
+      else setLocalDisagree((v) => v - 1)
+    } else {
+      if (localVote) {
+        if (localVote === "agree") setLocalAgree((v) => v - 1)
+        else setLocalDisagree((v) => v - 1)
+      }
+      setLocalVote(vote)
+      if (vote === "agree") setLocalAgree((v) => v + 1)
+      else setLocalDisagree((v) => v + 1)
+    }
+
+    try {
+      const res = await fetch(`/api/hot-takes/${params.id}/vote`, {
+        method: "POST",
+        headers: { "Content-Type": "application/json" },
+        body: JSON.stringify({ vote }),
+      })
+
+      if (!res.ok) {
+        throw new Error("Failed to vote")
+      }
+    } catch {
+      // Revert on error
+      setLocalVote(previousVote)
+      setLocalAgree(previousAgree)
+      setLocalDisagree(previousDisagree)
+    } finally {
+      setIsVoting(false)
+    }
+  }
+
+  if (loading) {
+    return (
+      <div className="max-w-4xl mx-auto px-4 py-12">
+        <div className="animate-pulse">
+          <div className="h-8 bg-[#222] w-32 mb-4" />
+          <div className="h-12 bg-[#222] w-3/4 mb-8" />
+          <div className="aspect-video bg-[#222]" />
+        </div>
+      </div>
+    )
+  }
+
+  if (error || !hotTake) {
+    return (
+      <div className="max-w-4xl mx-auto px-4 py-12 text-center">
+        <h1 className="text-4xl font-bold mb-4">404</h1>
+        <p className="text-[#666] mb-8">{error || "Hot take not found"}</p>
+        <Link
+          href="/hot-takes"
+          className="inline-block bg-white text-black px-6 py-3 font-bold text-sm tracking-wide hover:bg-[#f0f0f0] transition-colors"
+        >
+          BACK TO HOT TAKES
+        </Link>
+      </div>
+    )
+  }
+
+  const stanceConfig = STANCE_LABELS[hotTake.stance] || {
+    label: hotTake.stance,
+    color: "#888",
+  }
+  const total = localAgree + localDisagree
+  const agreeRatio = total > 0 ? localAgree / total : 0.5
+
+  return (
+    <div className="max-w-4xl mx-auto px-4 py-6 lg:py-12">
+      {/* Back link */}
+      <Link
+        href="/hot-takes"
+        className="inline-block text-[10px] tracking-[0.2em] uppercase text-[#666] hover:text-white mb-8"
+      >
+        ← Back to Hot Takes
+      </Link>
+
+      {/* Main content */}
+      <article className="border border-[--border] bg-[--background]">
+        {/* Header bar */}
+        <div className="flex items-center justify-between px-6 py-4 border-b border-[#222]">
+          <div className="flex items-center gap-4">
+            <span
+              className="text-[10px] tracking-[0.2em] font-bold px-3 py-1"
+              style={{ color: stanceConfig.color, border: `1px solid ${stanceConfig.color}` }}
+            >
+              {stanceConfig.label}
+            </span>
+          </div>
+          <span className="text-[10px] tracking-[0.1em] uppercase text-[#444]">
+            {new Date(hotTake.createdAt).toLocaleDateString("en-US", {
+              month: "long",
+              day: "numeric",
+              year: "numeric",
+            })}
+          </span>
+        </div>
+
+        {/* Album and content */}
+        <div className="grid grid-cols-1 lg:grid-cols-12">
+          {/* Album art */}
+          <div className="lg:col-span-5">
+            <Link href={`/album/${hotTake.albumSpotifyId}`} className="block">
+              <div className="relative aspect-square bg-[#111] overflow-hidden group">
+                {(hotTake.albumCoverUrlLarge || hotTake.albumCoverUrl) && (
+                  <img
+                    src={hotTake.albumCoverUrlLarge || hotTake.albumCoverUrl || ""}
+                    alt={hotTake.albumTitle}
+                    className="w-full h-full object-cover group-hover:scale-[1.02] transition-transform duration-500"
+                  />
+                )}
+                <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 to-transparent">
+                  <p className="text-[10px] tracking-[0.2em] uppercase text-[#888] mb-1">Album</p>
+                  <h2 className="font-bold text-xl leading-tight">{hotTake.albumTitle}</h2>
+                  <p className="text-sm text-[#888]">{hotTake.albumArtist}</p>
+                </div>
+              </div>
+            </Link>
+          </div>
+
+          {/* Content */}
+          <div className="lg:col-span-7 p-6 lg:p-8 flex flex-col">
+            {/* The hot take */}
+            <div className="mb-8">
+              <p className="text-[10px] tracking-[0.2em] uppercase text-[#666] mb-3">
+                The Take
+              </p>
+              <blockquote className="text-2xl lg:text-3xl font-bold leading-tight mb-4">
+                {hotTake.content}
+              </blockquote>
+              <p className="text-sm text-[#666]">
+                by{" "}
+                <Link href={`/u/${hotTake.authorUsername}`} className="text-white hover:underline">
+                  @{hotTake.authorUsername}
+                </Link>
+              </p>
+            </div>
+
+            {/* Temperature gauge */}
+            {total > 0 && (
+              <div className="mb-8">
+                <p className="text-[10px] tracking-[0.2em] uppercase text-[#666] mb-3">
+                  Community Verdict
+                </p>
+                <div className="flex items-center gap-4">
+                  <div className="flex-1 h-2 bg-[#222] relative overflow-hidden">
+                    <div
+                      className="absolute left-0 top-0 h-full bg-white transition-all duration-300"
+                      style={{ width: `${agreeRatio * 100}%` }}
+                    />
+                    <div
+                      className="absolute right-0 top-0 h-full bg-[#ff3b3b] transition-all duration-300"
+                      style={{ width: `${(1 - agreeRatio) * 100}%` }}
+                    />
+                  </div>
+                </div>
+                <div className="flex justify-between mt-2 text-[10px] tracking-[0.1em] uppercase text-[#666]">
+                  <span>{Math.round(agreeRatio * 100)}% agree</span>
+                  <span>{Math.round((1 - agreeRatio) * 100)}% disagree</span>
+                </div>
+              </div>
+            )}
+
+            {/* Voting buttons */}
+            <div className="grid grid-cols-2 gap-4">
+              <button
+                onClick={() => handleVote("agree")}
+                disabled={isVoting}
+                className={`py-5 font-bold text-sm tracking-wide transition-all border ${
+                  localVote === "agree"
+                    ? "bg-white text-black border-white"
+                    : "bg-transparent text-white border-[#333] hover:border-white"
+                }`}
+              >
+                <span className="block text-3xl mb-1">{localAgree}</span>
+                <span className="text-[10px] tracking-[0.15em] uppercase">
+                  {localVote === "agree" ? "AGREED" : "AGREE"}
+                </span>
+              </button>
+              <button
+                onClick={() => handleVote("disagree")}
+                disabled={isVoting}
+                className={`py-5 font-bold text-sm tracking-wide transition-all border ${
+                  localVote === "disagree"
+                    ? "bg-[#ff3b3b] text-white border-[#ff3b3b]"
+                    : "bg-transparent text-white border-[#333] hover:border-[#ff3b3b]"
+                }`}
+              >
+                <span className="block text-3xl mb-1">{localDisagree}</span>
+                <span className="text-[10px] tracking-[0.15em] uppercase">
+                  {localVote === "disagree" ? "DISAGREED" : "DISAGREE"}
+                </span>
+              </button>
+            </div>
+          </div>
+        </div>
+
+        {/* Arguments section */}
+        {(hotTake.agreeArguments.length > 0 || hotTake.disagreeArguments.length > 0) && (
+          <div className="border-t border-[#222] p-6 lg:p-8">
+            <h3 className="text-[10px] tracking-[0.3em] uppercase text-[#666] mb-6">
+              The Debate
+            </h3>
+
+            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
+              {/* Agree side */}
+              <div>
+                <h4 className="text-sm font-bold tracking-wide mb-4 flex items-center gap-2">
+                  <span className="w-3 h-3 bg-white" />
+                  AGREE ({hotTake.agreeArguments.length})
+                </h4>
+                <div className="space-y-4">
+                  {hotTake.agreeArguments.map((arg) => (
+                    <div key={arg.id} className="pl-4 border-l-2 border-white">
+                      <p className="text-sm text-[#ccc]">{arg.content}</p>
+                      <p className="text-[10px] tracking-[0.1em] uppercase text-[#666] mt-2">
+                        @{arg.authorUsername} · {arg.likes} likes
+                      </p>
+                    </div>
+                  ))}
+                  {hotTake.agreeArguments.length === 0 && (
+                    <p className="text-sm text-[#444]">No arguments yet</p>
+                  )}
+                </div>
+              </div>
+
+              {/* Disagree side */}
+              <div>
+                <h4 className="text-sm font-bold tracking-wide mb-4 flex items-center gap-2">
+                  <span className="w-3 h-3 bg-[#ff3b3b]" />
+                  DISAGREE ({hotTake.disagreeArguments.length})
+                </h4>
+                <div className="space-y-4">
+                  {hotTake.disagreeArguments.map((arg) => (
+                    <div key={arg.id} className="pl-4 border-l-2 border-[#ff3b3b]">
+                      <p className="text-sm text-[#ccc]">{arg.content}</p>
+                      <p className="text-[10px] tracking-[0.1em] uppercase text-[#666] mt-2">
+                        @{arg.authorUsername} · {arg.likes} likes
+                      </p>
+                    </div>
+                  ))}
+                  {hotTake.disagreeArguments.length === 0 && (
+                    <p className="text-sm text-[#444]">No arguments yet</p>
+                  )}
+                </div>
+              </div>
+            </div>
+          </div>
+        )}
+      </article>
+
+      {/* More hot takes prompt */}
+      <div className="mt-12 text-center">
+        <Link
+          href="/hot-takes"
+          className="text-[10px] tracking-[0.2em] uppercase text-[#666] hover:text-white transition-colors"
+        >
+          View More Hot Takes →
+        </Link>
+      </div>
+    </div>
+  )
+}
diff --git a/src/app/hot-takes/page.tsx b/src/app/hot-takes/page.tsx
index 24004da..455e1d4 100644
--- a/src/app/hot-takes/page.tsx
+++ b/src/app/hot-takes/page.tsx
@@ -184,9 +184,6 @@ export default async function HotTakesPage() {
             <HotTakeCard
               key={hotTake.id}
               hotTake={hotTake}
-              onVote={async () => {
-                // Client-side voting handled by component
-              }}
             />
           ))}
         </div>
diff --git a/src/components/hot-take-card.tsx b/src/components/hot-take-card.tsx
index 11c0532..507ed6c 100644
--- a/src/components/hot-take-card.tsx
+++ b/src/components/hot-take-card.tsx
@@ -85,10 +85,12 @@ export function HotTakeCard({ hotTake, onVote, compact = false }: HotTakeCardPro
   const stanceConfig = STANCE_LABELS[hotTake.stance]
 
   const handleVote = async (vote: "agree" | "disagree") => {
-    if (isVoting || !onVote) return
+    if (isVoting) return
 
     setIsVoting(true)
     const previousVote = localVote
+    const previousAgree = localAgree
+    const previousDisagree = localDisagree
 
     // Optimistic update
     if (localVote === vote) {
@@ -109,12 +111,24 @@ export function HotTakeCard({ hotTake, onVote, compact = false }: HotTakeCardPro
     }
 
     try {
-      await onVote(hotTake.id, vote)
+      // Call onVote callback if provided, otherwise call API directly
+      if (onVote) {
+        await onVote(hotTake.id, vote)
+      } else {
+        const res = await fetch(`/api/hot-takes/${hotTake.id}/vote`, {
+          method: "POST",
+          headers: { "Content-Type": "application/json" },
+          body: JSON.stringify({ vote }),
+        })
+        if (!res.ok) {
+          throw new Error("Failed to vote")
+        }
+      }
     } catch {
       // Revert on error
       setLocalVote(previousVote)
-      setLocalAgree(hotTake.agreeCount)
-      setLocalDisagree(hotTake.disagreeCount)
+      setLocalAgree(previousAgree)
+      setLocalDisagree(previousDisagree)
     } finally {
       setIsVoting(false)
     }
-- 
2.50.1 (Apple Git-155)

